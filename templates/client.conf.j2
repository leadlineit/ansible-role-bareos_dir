#{{ ansible_managed }}
Client {
    Name = {{ item.name }}
    Address = {{ item.address }}
    FDPort = {{ item.fdport | default("9102") }}
    Description = "{{ item.description | default(item.name) }}"
    File Retention = 15 days
    Auto Prune = yes
    Password = "{{ item.password | default() }}"
    Passive = "{{ item.passive | default(no) }}"
{% if item.tls_enable is defined %}    
    TLS Enable = {{ item.tls_enable }}
    TLS Require = {{ item.tls_enable }}
    TLS CA Certificate File = {{ bareos_tls_path }}/CA.crt
    TLS Certificate = {{ bareos_tls_path }}/{{ ansible_nodename }}.crt
    TLS Key = {{ bareos_tls_path }}/{{ ansible_nodename }}.key
{% endif %}
}

{% if item.jobs is defined %}
{% for j in item.jobs %}

Job {
    Name = "{{ j.name }}"
    Client = {{ j.client }}
    Description = "{{ j.description | default(j.name) }}"
    JobDefs = {{ j.jobdef }}
    Enabled = yes
    Run Script {
       Console = ".bvfs_update jobid=%i"
       RunsWhen = After
       RunsOnClient = No
    }
}
{% endfor %}
{% endif %}
